<!DOCTYPE html>
<html>
    <head>
        <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
        <script type="text/javascript" charset="utf-8">
            var socket = io();
            //this allows the server to send posts to the client
            socket.on('add_post', function(data) {
                poster = data.poster;
                post_number = data.post_number;
                new_post = data.new_post;
                //insert post
                document.getElementById(poster == '{{ current_user.username }}' ? "current_user_content" : "other_user_content").insertAdjacentHTML('afterbegin', new_post);

                //activate comment box
                /*
                document.getElementById("user_" + poster + "_post_" + post_number + "_comment_form").onsubmit = function(event) {
                    event.preventDefault();
                    comment_text = document.getElementById(poster + "_" + post_number + "_comment_text").value;
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/comment/', true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhr.onload = function(){};
                    const data = 'poster=' + encodeURIComponent(poster) + '&post_number=' + encodeURIComponent(post_number) + '&comment_text=' + encodeURIComponent(comment_text);
                    xhr.send(data)
                };
                */
               

                (function(currentPoster, currentPostNumber) {
                    document.getElementById("user_" + currentPoster + "_post_" + currentPostNumber + "_comment_form").onsubmit = function(event) {
                        event.preventDefault();
                        const comment_text = document.getElementById(currentPoster + "_" + currentPostNumber + "_comment_text").value;
                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', '/comment/', true);
                        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                        xhr.onload = function(){};
                        const data = 'poster=' + encodeURIComponent(currentPoster) + '&post_number=' + encodeURIComponent(currentPostNumber) + '&comment_text=' + encodeURIComponent(comment_text);
                        xhr.send(data);
                    };
                })(poster, post_number);




            });

            //this allows the server to send individual clients
            socket.on('add_comment', function(data) {
                console.log(data.poster + ' ' + data.post_number)
                comment_section_id = 'user_' + data.poster + '_post_' + data.post_number + '_comments';
                document.getElementById(comment_section_id).insertAdjacentHTML('beforeend', data.new_comment);
            });
        </script>
    </head>
    <body>
        <h1>BERYLLIUM</h1>

        {% include 'friend_search.html' %}

        <div id="current_user_content"></div>

        <div id="image_upload">
            {% if current_user.can_post %}
                {% include 'form.html' %}
            {% endif %}
        </div>


        <div id="other_user_content">
            <p>You must post before viewing others' images!</p>
        </div>

        <br><a href="/logout">Logout</a>
    </body>
</html>